name: Update Repository Languages

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:    # Manual trigger
  push:
    branches: ["master", "main"]
    paths-ignore: ["studio/*.json"]  # Avoid re-runs on metric updates

permissions:
  contents: write

jobs:
  update-languages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and aggregate languages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'EOF'
          import requests
          import os
          import json

          token = os.environ['GITHUB_TOKEN']
          owner = os.environ['GITHUB_REPOSITORY_OWNER']  # Auto-set by GitHub

          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # Get all user's non-forked repos
          repos = []
          page = 1
          while True:
              resp = requests.get(
                  f'https://api.github.com/users/{owner}/repos',
                  headers=headers,
                  params={'per_page': 100, 'page': page, 'sort': 'updated'}
              )
              if resp.status_code != 200 or not resp.json():
                  break
              for repo in resp.json():
                  if not repo['fork']:
                      repos.append(repo['full_name'])
              page += 1

          # Aggregate languages
          lang_bytes = {}
          for repo_name in repos:
              resp = requests.get(
                  f'https://api.github.com/repos/{repo_name}/languages',
                  headers=headers
              )
              if resp.status_code == 200:
                  for lang, bytes_count in resp.json().items():
                      lang_bytes[lang] = lang_bytes.get(lang, 0) + bytes_count

          total = sum(lang_bytes.values())
          if total > 0:
              sorted_langs = sorted(lang_bytes.items(), key=lambda x: x[1], reverse=True)
              result = [
                  {"stack": lang, "percentage": round(bytes_count / total * 100, 2)}
                  for lang, bytes_count in sorted_langs
              ]
          else:
              result = []

          with open('languages.json', 'w') as f:
              json.dump(result, f, indent=2)

          print("languages.json generated successfully")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add languages.json
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update languages.json"
            git push
          fi
